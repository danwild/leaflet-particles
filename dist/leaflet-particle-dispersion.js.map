{"version":3,"file":"leaflet-particle-dispersion.js","sources":["../src/js/L.ParticleDispersionLayer.js"],"sourcesContent":["\n// dependencies\nimport chroma from 'chroma-js';\nimport heatBin from 'leaflet-heatbin';\n\nconst ParticleDispersionLayer = (L.Layer ? L.Layer : L.Class).extend({\n\n\t// misc\n\t_particleLayer: null,\n\t_frameIndex:    0,\n\t_markers:       [],\n\t_colors:        null,\n\n\t/*------------------------------------ LEAFLET SPECIFIC ------------------------------------------*/\n\n\t_active:   false,\n\t_map:      null,\n\t// the L.canvas renderer\n\t_renderer: null,\n\t// the DOM leaflet-pane that contains html canvas\n\t_pane:     null,\n\n\t// user options\n\toptions: {\n\t\tdata:            null,\n\t\tdataFormat: {\n\t\t\tidIndex:    0,\n\t\t\tlonIndex:   1,\n\t\t\tlatIndex:   2,\n\t\t\tdepthIndex: 3,\n\t\t\tageIndex:   4\n\t\t},\n\t\tdisplayMode:     '',\n\t\tstartFrameIndex: 0,\n\t\tageColorScale:   null,\n\t\tageDomain:       null,\n\t\theatOptions: {\n\t\t\tblur: 1,\n\t\t\t// radius should be small ONLY if scaleRadius is true (or small radius is intended)\n\t\t\t// if scaleRadius is false it will be the constant radius used in pixels\n\t\t\t\"radiusMeters\": 1000,\n\t\t\t\"fixedRadius\": false,\n\t\t\t\"radius\": 20,\n\t\t\t\"heatBin\": {\n\t\t\t\t\"enabled\": false,\n\t\t\t\t\"cellSizeKm\": 1\n\t\t\t},\n\t\t\t\"maxOpacity\": .8,\n\t\t\t// scales the radius based on map zoom\n\t\t\t\"scaleRadius\": false,\n\t\t\t// if set to false the heatmap uses the global maximum for colorization\n\t\t\t// if activated: uses the data maximum within the current map boundaries\n\t\t\t//   (there will always be a red spot with useLocalExtremas true)\n\t\t\t\"useLocalExtrema\": false,\n\t\t\t// which field name in your data represents the latitude - default \"lat\"\n\t\t\tlatField: 'lat',\n\t\t\t// which field name in your data represents the longitude - default \"lng\"\n\t\t\tlngField: 'lng',\n\t\t\t// which field name in your data represents the data value - default \"value\"\n\t\t\tvalueField: 'value'\n\t\t},\n\t\texposureIntensity: 1,\n\t\tfinalIntensity: 1\n\t},\n\n\tinitialize: function (options) {\n\t\t// (L.setOptions was not working as expected)\n\t\tthis.options = this._extendObject(this.options, options);\n\t},\n\n\t/**\n\t * Initialise renderer when layer is added to the map / becomes active,\n\t * and draw circle markers if user has specified the displayMode\n\t *\n\t * @param map {Object} Leaflet map\n\t */\n\tonAdd: function (map) {\n\t\tthis._active = true;\n\t\tthis._map = map;\n\t\tthis._createRenderer();\n\t\tif (this.options.displayMode) this.setDisplayMode(this.options.displayMode);\n\t},\n\n\t/**\n\t * Remove the pane from DOM, and void renderer when layer removed from map\n\t */\n\tonRemove () {\n\t\tthis._map.removeLayer(this._particleLayer);\n\t\tL.DomUtil.remove(this._pane);\n\t\tthis._renderer = null;\n\t\tthis._particleLayer = null;\n\t\tthis._active = false;\n\t},\n\n\t/*------------------------------------ PUBLIC ------------------------------------------*/\n\n\t/**\n\t * check if the particle layer is currently active on the map\n\t * @returns {boolean}\n\t */\n\tisActive () {\n\t\treturn this._active;\n\t},\n\n\t/**\n\t * Update the layer with new data\n\t * @param data\n\t */\n\tsetData (data) {\n\t\tthis.options.data = data;\n\t\tthis.setDisplayMode(this.options.displayMode);\n\t},\n\n\t/**\n\t * Set options object, updates layer\n\t * @param options\n\t */\n\tsetOptions (options) {\n\t\tthis.options = this._extendObject(this.options, options);\n\t\tthis.update();\n\t},\n\n\t/**\n\t * Trigger layer update/redraw\n\t */\n\tupdate () {\n\t\tthis.setDisplayMode(this.options.displayMode);\n\t},\n\n\t/**\n\t * Set the display mode of the layer\n\t * @param mode {string} One of: ['FINAL', 'EXPOSURE', 'KEYFRAME']\n\t */\n\tsetDisplayMode (mode) {\n\n\t\tthis.options.displayMode = mode;\n\n\t\tif (!this.isActive()) return;\n\n\t\tswitch (this.options.displayMode) {\n\n\t\t\tcase 'EXPOSURE':\n\t\t\t\tthis._initDisplayExposure();\n\t\t\t\tbreak;\n\n\t\t\tcase 'FINAL':\n\t\t\t\tthis._initDisplayFinal();\n\t\t\t\tbreak;\n\n\t\t\tcase 'KEYFRAME':\n\t\t\t\tthis._initDisplayKeyframe();\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tconsole.error(`Attempted to initialise with invalid displayMode: ${this.options.displayMode}`);\n\t\t\t\tbreak;\n\t\t}\n\t},\n\n\t/**\n\t * Returns the current `displayMode`\n\t * @returns {string} One of: ['FINAL', 'EXPOSURE', 'KEYFRAME', null]\n\t */\n\tgetDisplayMode () {\n\t\treturn this.options.displayMode;\n\t},\n\n\t/**\n\t * Display the particles at the given frame index\n\t * @param index {number} the keyframe index\n\t */\n\tsetFrameIndex (index) {\n\n\t\tif (!this.isActive()) return;\n\t\tconst self = this;\n\t\tself._frameIndex = index;\n\n\t\tconst keys = Object.keys(self.options.data);\n\t\tconst frame = self.options.data[keys[index]];\n\n\t\t// there's no addLayer*s* function, either need to add each\n\t\t// L.circleMarker individually, or reinit the entire layer\n\t\tif (self._particleLayer) self._particleLayer.clearLayers();\n\n\t\tfor (let i = 0; i < frame.length; i++) {\n\n\t\t\tconst particle = frame[i];\n\t\t\tconst pos = self._map.wrapLatLng([particle[self.options.dataFormat.latIndex], particle[self.options.dataFormat.lonIndex]]);\n\t\t\tlet marker = L.circleMarker(pos, {\n\t\t\t\trenderer:    self._renderer,\n\t\t\t\tstroke:      false,\n\t\t\t\tfillOpacity: 0.3,\n\t\t\t\tradius: 8,\n\t\t\t\tfillColor:   this._colors(particle[self.options.dataFormat.ageIndex]).hex(),\n\t\t\t\t_feature:    particle\n\n\t\t\t});\n\n\t\t\tself._markers.push(marker);\n\t\t\tself._particleLayer.addLayer(marker);\n\t\t}\n\t},\n\n\t/**\n\t * Returns leaflet LatLngBounds of the layer\n\t */\n\tgetLatLngBounds () {\n\n\t\tif (!this.options.data || !this._map) return null;\n\n\t\t// get keys, flatten the data\n\t\tconst snapshots = this._flattened();\n\n\t\treturn L.latLngBounds(snapshots.map((s) => {\n\t\t\treturn this._map.wrapLatLng([s[this.options.dataFormat.latIndex], s[this.options.dataFormat.lonIndex]]);\n\t\t}));\n\t},\n\n\t/**\n\t * A wrapper function for `L.heatBin.getGridInfo` to get information about the grid used for binning\n\t * @returns {*}\n\t */\n\tgetGridInfo () {\n\t\tif (!this._active || !this._particleLayer || !this._particleLayer.getGridInfo) return null;\n\t\treturn this._particleLayer.getGridInfo();\n\t},\n\n\t/**\n\t * Return readonly particleLayer\n\t * @returns {null}\n\t */\n\tgetParticleLayer () {\n\t\treturn this._particleLayer;\n\t},\n\n\t/**\n\t * Return an array of unique particle ID's\n\t * @returns {Array}\n\t */\n\tgetParticleIds () {\n\t\tconst snapshots = this._flattened();\n\t\t// get an array of uniq particles\n\t\tlet uids = [];\n\t\tsnapshots.forEach((snapshot) => {\n\t\t\tif (uids.indexOf(snapshot[this.options.dataFormat.idIndex]) === -1) uids.push(snapshot[this.options.dataFormat.idIndex]);\n\t\t});\n\t\treturn uids;\n\t},\n\n\t/**\n\t * Return the min/max percent range on a heatBin layer with unique ID's\n\t * i.e. what is the min/max percent of unique data points that have touched any grid cell\n\t * @returns {*}\n\t */\n\tgetUniquePercentRange () {\n\t\tif (!this._active || !this._particleLayer || !this._particleLayer.getGridInfo) return null;\n\t\tconst gridInfo = this.getGridInfo();\n\t\tconst ids = this.getParticleIds();\n\t\tif (!gridInfo.hasOwnProperty('maxCellCount')) return null;\n\t\tlet minPercent = gridInfo.minCellCount / ids.length;\n\t\treturn {\n\t\t\tmin: minPercent >= 0 ? minPercent : 0,\n\t\t\tmax: (gridInfo.maxCellCount / ids.length) * 100\n\t\t};\n\t},\n\n\t/*------------------------------------ PRIVATE ------------------------------------------*/\n\n\t_flattened () {\n\t\tlet keys = Object.keys(this.options.data);\n\t\tlet snapshots = [];\n\t\tkeys.forEach((key) => { snapshots = snapshots.concat(this.options.data[key]); });\n\t\treturn snapshots;\n\t},\n\n\t/**\n\t * Create the L.canvas renderer and custom pane to display particles\n\t * @private\n\t */\n\t_createRenderer () {\n\t\t// create separate pane for canvas renderer\n\t\tthis._pane = this._map.createPane('particle-dispersion');\n\t\tthis._renderer = L.canvas({ pane: 'particle-dispersion' });\n\t},\n\n\t/**\n\t * Remove the particle layer from the map and clear our reference\n\t * @private\n\t */\n\t_clearDisplay () {\n\t\tif (this._particleLayer) this._map.removeLayer(this._particleLayer);\n\t\tthis._particleLayer = null;\n\t},\n\n\t/**\n\t * @summary Create a chroma-js color scale with user settings or auto scaled to keyframe range\n\t * @returns {Object} chromaJs color object\n\t * @private\n\t */\n\t_createColors () {\n\t\tif (!this.options.ageDomain) this.options.ageDomain = [0, Object.keys(this.options.data).length];\n\t\tthis._colors = chroma.scale(this.options.ageColorScale).domain(this.options.ageDomain);\n\t\treturn this._colors;\n\t},\n\n\t/**\n\t * Create the display layer (heatmap) for FINAL distribution.\n\t * @private\n\t */\n\t_initDisplayFinal () {\n\n\t\tthis._clearDisplay();\n\n\t\tif (this.options.data){\n\n\t\t\tthis._createColors();\n\t\t\tconst finalData = this._createFinalData();\n\t\t\tthis._particleLayer = L.heatBin(this.options.heatOptions);\n\t\t\tthis._particleLayer.addTo(this._map);\n\t\t\tthis._particleLayer.setData(finalData);\n\t\t}\n\t},\n\n\t/**\n\t * Process data into expected leaflet.heat format,\n\t * plotting only particles at their end of life\n\t * [ [lat, lon, intensity], ... ]\n\t * @private\n\t */\n\t_createFinalData () {\n\n\t\tlet finalData = [];\n\n\t\t// get keys, moving forward in time\n\t\tlet keys = Object.keys(this.options.data);\n\t\tkeys.sort((a, b) => { return new Date(a) - new Date(b); });\n\n\t\t// flatten the data\n\t\tlet snapshots = [];\n\t\tkeys.forEach((key) => { snapshots = snapshots.concat(this.options.data[key]); });\n\n\t\t// get an array of uniq particles\n\t\tlet uids = [];\n\t\tsnapshots.forEach((snapshot) => {\n\t\t\tif (uids.indexOf(snapshot[this.options.dataFormat.idIndex]) === -1) uids.push(snapshot[this.options.dataFormat.idIndex]);\n\t\t});\n\n\t\t// step backwards from the end of the sim collecting\n\t\t// final snapshots for each uniq particle\n\t\tkeys.reverse();\n\n\t\tfor (let i = 0; i < keys.length; i++) {\n\n\t\t\tif (uids.length === 0) break;\n\n\t\t\t// check each particle in the snapshot\n\t\t\tthis.options.data[keys[i]].forEach((snapshot) => {\n\n\t\t\t\t// if not recorded\n\t\t\t\tlet index = uids.indexOf(snapshot[this.options.dataFormat.idIndex]);\n\t\t\t\tif (index !== -1) {\n\n\t\t\t\t\t// grab it, and remove it from the list\n\t\t\t\t\tfinalData.push({\n\t\t\t\t\t\tlat:   snapshot[this.options.dataFormat.latIndex],\n\t\t\t\t\t\tlng:   snapshot[this.options.dataFormat.lonIndex],\n\t\t\t\t\t\tvalue: this.options.finalIntensity\n\t\t\t\t\t});\n\t\t\t\t\tuids.splice(index, 1);\n\t\t\t\t}\n\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\tmax: 10,\n\t\t\tdata: finalData\n\t\t};\n\t},\n\n\t/**\n\t * Process data into expected leaflet.heat format,\n\t * plotting all particles for every snapshot\n\t * [ [lat, lon, intensity], ... ]\n\t * @private\n\t */\n\t_createExposureData () {\n\n\t\tlet exposureData = [];\n\t\tlet keys = Object.keys(this.options.data);\n\n\t\tkeys.forEach((key) => {\n\t\t\tthis.options.data[key].forEach((particle) => {\n\t\t\t\texposureData.push({\n\t\t\t\t\tlat:   particle[this.options.dataFormat.latIndex],\n\t\t\t\t\tlng:   particle[this.options.dataFormat.lonIndex],\n\t\t\t\t\tuid:   particle[this.options.dataFormat.idIndex],\n\t\t\t\t\tvalue: this.options.exposureIntensity\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\treturn { min: 0, max: 10, data: exposureData };\n\t},\n\n\t/**\n\t * Create the display layer (heatmap) for cumulative EXPOSURE\n\t * @private\n\t */\n\t_initDisplayExposure () {\n\n\t\tthis._clearDisplay();\n\n\t\tif (this.options.data){\n\t\t\tthis._createColors();\n\t\t\tconst exposureData = this._createExposureData();\n\t\t\tconsole.log(exposureData);\n\t\t\tthis._particleLayer = L.heatBin(this.options.heatOptions);\n\t\t\tthis._particleLayer.addTo(this._map);\n\t\t\tthis._particleLayer.setData(exposureData);\n\t\t}\n\t},\n\n\t/**\n\t * Create the display layer (L.CircleMarkers) for KEYFRAME's\n\t * @private\n\t */\n\t_initDisplayKeyframe () {\n\n\t\tthis._clearDisplay();\n\n\t\tif (this.options.data){\n\t\t\t// init the feature group and display first frame\n\t\t\tthis._createColors();\n\t\t\tthis._particleLayer = L.featureGroup();\n\t\t\tthis._markers = [];\n\t\t\tthis.setFrameIndex(this._frameIndex);\n\t\t\tthis._particleLayer.addTo(this._map);\n\t\t} else {\n\t\t\tconsole.error('Attempted to display keyframes but there is no data.')\n\t\t}\n\t},\n\n\t/**\n\t * Deep merge Objects,\n\t * Note that destination arrays will be overwritten where they exist in source.\n\t * @param destination\n\t * @param source\n\t * @returns {*}\n\t */\n\t_extendObject (destination, source) {\n\t\tlet self = this;\n\t\tfor (const property in source) {\n\t\t\t// .constructor avoids tripping over prototypes etc.\n\t\t\t// don't traverse the data..\n\t\t\tif (property === 'data') {\n\t\t\t\tdestination[property] = source[property];\n\t\t\t} else if (source[property] && source[property].constructor && source[property].constructor === Object) {\n\t\t\t\tdestination[property] = destination[property] || {};\n\t\t\t\tself._extendObject(destination[property], source[property]);\n\t\t\t} else {\n\t\t\t\tdestination[property] = source[property];\n\t\t\t}\n\t\t}\n\t\treturn destination;\n\t}\n\n});\n\nL.particleDispersionLayer = function(options) {\n\treturn new ParticleDispersionLayer(options);\n};\n\nexport default L.particleDispersionLayer;\n\n\n\n\n"],"names":["ParticleDispersionLayer","L","Layer","Class","extend","_particleLayer","_frameIndex","_markers","_colors","_active","_map","_renderer","_pane","options","data","dataFormat","idIndex","lonIndex","latIndex","depthIndex","ageIndex","displayMode","startFrameIndex","ageColorScale","ageDomain","heatOptions","blur","latField","lngField","valueField","exposureIntensity","finalIntensity","initialize","_extendObject","onAdd","map","_createRenderer","setDisplayMode","onRemove","removeLayer","DomUtil","remove","isActive","setData","setOptions","update","mode","_initDisplayExposure","_initDisplayFinal","_initDisplayKeyframe","console","error","getDisplayMode","setFrameIndex","index","self","keys","Object","frame","clearLayers","i","length","particle","pos","wrapLatLng","marker","circleMarker","renderer","stroke","fillOpacity","radius","fillColor","hex","_feature","push","addLayer","getLatLngBounds","snapshots","_flattened","latLngBounds","s","getGridInfo","getParticleLayer","getParticleIds","uids","forEach","snapshot","indexOf","getUniquePercentRange","gridInfo","ids","hasOwnProperty","minPercent","minCellCount","min","max","maxCellCount","key","concat","createPane","canvas","pane","_clearDisplay","_createColors","chroma","scale","domain","finalData","_createFinalData","heatBin","addTo","sort","a","b","Date","reverse","lat","lng","value","splice","_createExposureData","exposureData","uid","log","featureGroup","destination","source","property","constructor","particleDispersionLayer"],"mappings":"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"}