"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(t,e){if("undefined"!=typeof module&&module.exports)module.exports=t(require("heatmap.js"),require("leaflet"));else if("function"==typeof define&&define.amd)define(["heatmap.js","leaflet"],t);else{if(!e.h337||!e.L)throw new Error("Tried to init in browser context but had missing dependencies.");e.HeatmapOverlay=t(e.h337,e.L)}}(function(t,e){"undefined"==typeof e.Layer&&(e.Layer=e.Class);var i=e.Layer.extend({initialize:function(t){this.cfg=t,this._el=e.DomUtil.create("div","leaflet-zoom-hide"),this._data=[],this._max=1,this._min=0,this.cfg.container=this._el},onAdd:function(i){var a=i.getSize();this._map=i,this._width=a.x,this._height=a.y,this._el.style.width=a.x+"px",this._el.style.height=a.y+"px",this._el.style.position="absolute",this._origin=this._map.layerPointToLatLng(new e.Point(0,0)),i.getPanes().overlayPane.appendChild(this._el),this._heatmap||(this._heatmap=t.create(this.cfg)),i.on("moveend",this._reset,this),this._draw()},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._el),t.off("moveend",this._reset,this)},_draw:function(){if(this._map){var t=this._map.getPanes().mapPane,e=t._leaflet_pos;this._el.style[i.CSS_TRANSFORM]="translate("+-Math.round(e.x)+"px,"+-Math.round(e.y)+"px)",this._update()}},_getPixelRadius:function(){var t=this._map.getCenter(),e=this._map.latLngToContainerPoint(t),i=[e.x+1,e.y],a=this._map.containerPointToLatLng(e),s=this._map.containerPointToLatLng(i),n=a.distanceTo(s),r=this.cfg.radiusMeters/n;return r>=1?r:1},_update:function(){var t,e,i,a={max:this._max,min:this._min,data:[]};if(t=this._map.getBounds(),e=this._map.getZoom(),i=Math.pow(2,e),0==this._data.length)return void(this._heatmap&&this._heatmap.setData(a));for(var s=[],n=this.cfg.scaleRadius?i:1,r=0,o=0,h=this.cfg.valueField,l=this._data.length;l--;){var d=this._data[l],p=d[h],c=d.latlng;if(t.contains(c)){r=Math.max(p,r),o=Math.min(p,o);var _=this._map.latLngToContainerPoint(c),u={x:Math.round(_.x),y:Math.round(_.y)};u[h]=p;var f;f=this.cfg.radiusMeters?this._getPixelRadius():d.radius?d.radius*n:(this.cfg.radius||2)*n,u.radius=f,s.push(u)}}this.cfg.useLocalExtrema&&(a.max=r,a.min=o),a.data=s,this._heatmap.setData(a)},setData:function(t){this._max=t.max||this._max,this._min=t.min||this._min;for(var i=this.cfg.latField||"lat",a=this.cfg.lngField||"lng",s=this.cfg.valueField||"value",t=t.data,n=t.length,r=[];n--;){var o=t[n],h=new e.LatLng(o[i],o[a]),l={latlng:h};l[s]=o[s],o.radius&&(l.radius=o.radius),r.push(l)}this._data=r,this._draw()},addData:function(t){if(t.length>0)for(var i=t.length;i--;)this.addData(t[i]);else{var a=this.cfg.latField||"lat",s=this.cfg.lngField||"lng",n=this.cfg.valueField||"value",r=t,o=new e.LatLng(r[a],r[s]),h={latlng:o};h[n]=r[n],this._max=Math.max(this._max,h[n]),this._min=Math.min(this._min,h[n]),r.radius&&(h.radius=r.radius),this._data.push(h),this._draw()}},_reset:function(){this._origin=this._map.layerPointToLatLng(new e.Point(0,0));var t=this._map.getSize();this._width===t.x&&this._height===t.y||(this._width=t.x,this._height=t.y,this._el.style.width=this._width+"px",this._el.style.height=this._height+"px",this._heatmap._renderer.setDimensions(this._width,this._height)),this._draw()}});return i.CSS_TRANSFORM=function(){for(var t=document.createElement("div"),e=["transform","WebkitTransform","MozTransform","OTransform","msTransform"],i=0;i<e.length;i++){var a=e[i];if(void 0!==t.style[a])return a}return e[0]}(),i},window),function(t,e){if("function"==typeof define&&define.amd)define(["leaflet","heatmap.js","HeatmapOverlay","chroma-js"],t);else if("object"===("undefined"==typeof exports?"undefined":_typeof(exports)))module.exports=t(require("leaflet"),require("heatmap.js"),require("HeatmapOverlay"),require("chroma-js"));else{if(!("undefined"!=typeof e&&e.L&&e.HeatmapOverlay&&e.chroma))throw new Error("Tried to init in browser context but had missing dependencies.");e.L.particleDispersionLayer=t(L,e.HeatmapOverlay,e.chroma)}}(function(t,e,i){var a=(t.Layer?t.Layer:t.Class).extend({_pidIndex:0,_pLatIndex:1,_pLonIndex:0,_pDepthIndex:2,_pAgeIndex:3,_particleLayer:null,_frameIndex:0,_markers:[],_colors:null,_active:!1,_map:null,_renderer:null,_pane:null,options:{data:null,displayMode:"",startFrameIndex:0,ageColorScale:null,ageDomain:null,exposureHeatOptions:{},finalHeatOptions:{blur:1,radiusMeters:1e3,radius:20,maxOpacity:.8,scaleRadius:!1,useLocalExtrema:!1,latField:"lat",lngField:"lng",valueField:"value",onExtremaChange:function(t){console.log("onExtremaChange"),console.log(t)}},exposureIntensity:1,finalIntensity:1},initialize:function(t){this.options=this._extendObject(this.options,t)},onAdd:function(t){this._active=!0,this._map=t,this._createRenderer(),this.options.displayMode&&this.setDisplayMode(this.options.displayMode)},onRemove:function(){this._map.removeLayer(this._particleLayer),t.DomUtil.remove(this._pane),this._renderer=null,this._particleLayer=null,this._active=!1},isActive:function(){return this._active},setData:function(t){this.options.data=t,this.setDisplayMode(this.options.displayMode)},setDisplayMode:function(t){if(this.options.displayMode=t,this.isActive())switch(this.options.displayMode){case"EXPOSURE":this._initDisplayExposure();break;case"FINAL":this._initDisplayFinal();break;case"KEYFRAME":this._initDisplayKeyframe();break;default:console.error("Attempted to initialise with invalid displayMode: "+this.options.displayMode)}},setFrameIndex:function(e){if(this.isActive()){var i=this;i._frameIndex=e;var a=Object.keys(i.options.data),s=i.options.data[a[e]];i._particleLayer&&i._particleLayer.clearLayers();for(var n=0;n<s.length;n++){var r=s[n],o=i._map.wrapLatLng([r[i._pLatIndex],r[i._pLonIndex]]),h=t.circleMarker(o,{renderer:i._renderer,stroke:!1,fillOpacity:.3,radius:8,fillColor:this._colors(r[i._pAgeIndex]).hex(),_feature:r});i._markers.push(h),i._particleLayer.addLayer(h)}}},_createRenderer:function(){this._pane=this._map.createPane("particle-dispersion"),this._renderer=t.canvas({pane:"particle-dispersion"})},_clearDisplay:function(){this._particleLayer&&this._map.removeLayer(this._particleLayer),this._particleLayer=null},_createColors:function(){return this.options.ageDomain||(this.options.ageDomain=[0,Object.keys(this.options.data).length]),this._colors=i.scale(this.options.ageColorScale).domain(this.options.ageDomain),this._colors},_initDisplayFinal:function(){if(this._clearDisplay(),this.options.data){this._createColors();var t=this._createFinalData();this._particleLayer=new e(this.options.finalHeatOptions),this._particleLayer.addTo(this._map),this._particleLayer.setData(t)}},_createFinalData:function(){var t=this,e=[],i=Object.keys(this.options.data);i.sort(function(t,e){return new Date(t)-new Date(e)});var a=[];i.forEach(function(e){a=a.concat(t.options.data[e])});var s=[];a.forEach(function(e){s.indexOf(e[t._pidIndex])===-1&&s.push(e[t._pidIndex])}),i.reverse();for(var n=0;n<i.length&&0!==s.length;n++)this.options.data[i[n]].forEach(function(i){var a=s.indexOf(i[t._pidIndex]);a!==-1&&(e.push({lat:i[t._pLatIndex],lng:i[t._pLonIndex],value:t.options.finalIntensity}),s.splice(a,1))});return{max:200,data:e}},_createExposureData:function(){var t=this,e=[],i=Object.keys(this.options.data);return i.forEach(function(i){t.options.data[i].forEach(function(i){e.push([i[t._pLatIndex],i[t._pLonIndex],t.options.exposureIntensity])})}),e},_initDisplayExposure:function(){if(this._clearDisplay(),this.options.data){this._createColors();var e=this._createExposureData();this._particleLayer=t.heatLayer(e,this.options.exposureHeatOptions),this._particleLayer.addTo(this._map)}},_initDisplayKeyframe:function(){this._clearDisplay(),this.options.data?(this._createColors(),this._particleLayer=t.featureGroup(),this._markers=[],this.setFrameIndex(this._frameIndex),this._particleLayer.addTo(this._map)):console.error("Attempted to display keyframes but there is no data.")},_extendObject:function(t,e){var i=this;for(var a in e)"data"===a?t[a]=e[a]:e[a]&&e[a].constructor&&e[a].constructor===Object?(t[a]=t[a]||{},i._extendObject(t[a],e[a])):t[a]=e[a];return t}});return t.particleDispersionLayer=function(t){return new a(t)},t.particleDispersionLayer},window);